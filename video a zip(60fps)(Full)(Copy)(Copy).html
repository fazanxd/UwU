<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Optimizador MP3 — Limpieza de metadatos</title>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:28px auto;padding:20px}
    h1{font-size:1.4rem;margin-bottom:8px}
    .card{border:1px solid #e6e6e6;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    label{display:inline-block;margin-bottom:8px}
    input[type=file]{display:block;margin-bottom:12px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#0b74de;color:white;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .file-list{margin:10px 0}
    progress{width:100%;height:18px}
    .note{font-size:.9rem;color:#444;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Optimizador de MP3 (limpieza de metadatos)</h1>
    <p>Sube tus archivos MP3. Se eliminarán portadas e información innecesaria, y las etiquetas editables se rellenarán con <strong>"KRZ"</strong>. La calidad de audio se mantiene intacta (no se recomprime).</p><label>Selecciona MP3 (múltiple permitido):</label>
<input id="files" type="file" accept="audio/mpeg" multiple />

<div class="file-list" id="fileList"></div>

<div style="display:flex;gap:10px;align-items:center">
  <button id="process">Procesar y generar ZIP limpio</button>
  <a id="downloadLink" style="display:none;">Descargar ZIP</a>
</div>

<div style="margin-top:12px">
  <progress id="progress" max="100" value="0" style="display:none"></progress>
  <div id="status" class="note"></div>
</div>

<hr style="margin:18px 0">
<div class="note">Notas: usa <code>ffmpeg.wasm</code> en el navegador para limpiar los MP3. Se aplica <code>-c copy</code> (no recomprime audio) y <code>-map_metadata -1</code> para borrar metadatos, luego se añade la etiqueta <strong>KRZ</strong> en todos los campos editables.</div>

  </div>  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.5/dist/ffmpeg.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: false });

    const filesInput = document.getElementById('files');
    const fileListDiv = document.getElementById('fileList');
    const processBtn = document.getElementById('process');
    const progressEl = document.getElementById('progress');
    const statusEl = document.getElementById('status');
    const downloadLink = document.getElementById('downloadLink');

    let selectedFiles = [];

    filesInput.addEventListener('change', (e) => {
      selectedFiles = Array.from(e.target.files);
      renderFileList();
      downloadLink.style.display = 'none';
      downloadLink.href = '#';
    });

    function renderFileList(){
      if(!selectedFiles.length){ fileListDiv.innerHTML = '<em>No hay archivos seleccionados.</em>'; return }
      fileListDiv.innerHTML = '<ul>' + selectedFiles.map(f => `<li>${escapeHtml(f.name)} — ${(f.size/1024/1024).toFixed(2)} MB</li>`).join('') + '</ul>'
    }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    processBtn.addEventListener('click', async () => {
      if(!selectedFiles.length){ alert('Selecciona al menos un archivo'); return }
      processBtn.disabled = true;
      statusEl.textContent = 'Inicializando...';
      progressEl.style.display = 'block';
      progressEl.value = 0;

      if(!ffmpeg.isLoaded()){
        statusEl.textContent = 'Cargando motor ffmpeg.wasm...';
        try{
          await ffmpeg.load();
        }catch(err){
          console.error(err);
          alert('Error cargando ffmpeg en el navegador.');
          processBtn.disabled = false; progressEl.style.display='none'; statusEl.textContent='';
          return;
        }
      }

      const zip = new JSZip();
      let processed = 0;

      for(const file of selectedFiles){
        statusEl.textContent = `Procesando: ${file.name}`;
        const inName = `in_${processed}_${file.name}`;
        const outName = `${file.name.replace(/\.[^.]+$/,'')}_clean.mp3`;
        try{
          ffmpeg.FS('writeFile', inName, await fetchFile(file));
          // Copiar audio, borrar metadatos, y establecer KRZ en campos comunes
          await ffmpeg.run('-i', inName,
            '-c', 'copy',
            '-map_metadata', '-1',
            '-metadata', 'title=KRZ',
            '-metadata', 'artist=KRZ',
            '-metadata', 'album=KRZ',
            '-metadata', 'genre=KRZ',
            '-metadata', 'track=KRZ',
            outName);
          const data = ffmpeg.FS('readFile', outName);
          zip.file(outName, data);
          // cleanup
          ffmpeg.FS('unlink', inName);
          ffmpeg.FS('unlink', outName);
        }catch(err){
          console.error('Error procesando', file.name, err);
          // Si falla, agregar el original
          zip.file(file.name, await file.arrayBuffer());
        }

        processed++;
        progressEl.value = Math.round((processed/selectedFiles.length)*100);
      }

      statusEl.textContent = 'Empaquetando ZIP...';
      try{
        const content = await zip.generateAsync({ type:'blob' }, (meta) => {
          progressEl.value = Math.round(meta.percent);
        });
        const url = URL.createObjectURL(content);
        downloadLink.href = url;
        downloadLink.download = 'mp3_limpios.zip';
        downloadLink.style.display = 'inline-block';
        downloadLink.textContent = 'Descargar ZIP limpio';
        statusEl.textContent = 'Listo — descarga tu ZIP.';
      }catch(err){
        console.error(err);
        alert('Error generando ZIP.');
        statusEl.textContent = 'Error al generar ZIP.';
      }

      processBtn.disabled = false;
    });
  </script></body>
</html>
